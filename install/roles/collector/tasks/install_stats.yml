---

- name: Check if InfluxDB is installed
  shell: dpkg-query -W -f='${Version}\n' influxdb | sed 's/^[0-9]\+://'
  register: influxdb_check_deb
  ignore_errors: yes
  changed_when: influxdb_check_deb.stdout != '{{ influxdb_version }}'

- name: Download InfluxDB (64bits)
  get_url: url=https://s3.amazonaws.com/influxdb/influxdb_{{ influxdb_version }}_amd64.deb \
    dest=/tmp/ force=no
  when: influxdb_check_deb.stdout != '{{ influxdb_version }}'
    
- name: Install InfluxDB (64bits)
  shell: dpkg -i /tmp/influxdb_{{ influxdb_version }}_amd64.deb
  when: influxdb_check_deb.stdout != '{{ influxdb_version }}'
  
- name: Start InfluxDB
  service: name=influxdb state=started
  
- name: Wait a little
  wait_for: port={{ influxdb_port }} timeout=10
  
- name: Database Creation
  shell: curl -G http://localhost:{{ influxdb_port }}/query --data-urlencode "q={{ item }}"
  with_items:
    - CREATE DATABASE "{{ database_name }}"
    - CREATE USER "{{ database_username }}" WITH PASSWORD '{{ database_password }}' WITH ALL PRIVILEGES

