---

- name: Install python-pip
  apt: pkg=python-pip state=installed update_cache=false
  tags:
    - install

- name: Install Apscheduler and Django
  pip: name={{ item }}
  with_items:
    - apscheduler
    - django
  tags:
    - install

- name: Create OpenBACH repository
  file: path=/opt/openbach state=directory mode=0755
  tags:
    - install
    
- name: Copy the global variables file
  copy: src=../configs dest=/opt/openbach/
  tags:
    - install

- name: Copy the sources
  copy: src=../src/ dest=/opt/openbach/
  tags:
    - install
    
- name: Initialize the database
  shell: python /opt/openbach/backend/manage.py {{ item }}
  with_items:
    - makemigrations
    - migrate
  tags:
    - install
    
- name: Create a default superuser on the database
  shell: echo "from django.contrib.auth.models import User; User.objects.create_superuser('openbach', '', 'openbach')" | python /opt/openbach/backend/manage.py shell
  tags:
    - install

- name: Create openbach-backend service
  copy: src=roles/controller/templates/openbach-backend dest=/etc/init.d/ mode=0755
  tags:
    - install
    
- name: Start openbach-backend
  service: name=openbach-backend state=started
  tags:
    - install

