---

- hosts: localhost
  gather_facts: no
  pre_tasks:
    - name: Create temporary SSH key
      shell: ssh-keygen -b 4096 -t rsa -f /tmp/openbach_install_rsa -q -N ""
      args:
        creates: /tmp/openbach_install_rsa
      when: ansible_ssh_private_key_file is not defined

- name: Pre-configure each Host
  hosts:
    - agent
    - collector
    - controller
    - auditorium
  gather_facts: no
  
  pre_tasks:
    - name: Install python-minimal
      raw: sudo apt-get -y install python-minimal 
      become: yes
      ignore_errors: true

    - name: Use the temporary SSH key as the Default for this Installation
      set_fact: ansible_ssh_private_key_file=/tmp/openbach_install_rsa
      when: ansible_ssh_private_key_file is not defined


- name: Install Agents
  hosts: agent
  roles:
    - install_agent


- name: Install Collectors
  hosts: collector
  roles:
    - install_collector


- name: Install Controllers
  hosts: controller
  roles:
    - install_controller


- name: Install Auditoriums
  hosts: auditorium
  roles:
    - install_auditorium


- name: Configure each Agent
  hosts:
    - agent
    - collector
    - controller
  gather_facts: no
  roles:
    - configure_ssh_keys
    - install_job


- name: Setup Backend's Database
  hosts: controller
  gather_facts: no
  roles:
    - configure_backend


- name: Cleanup Generated Files
  hosts:
    - agent
    - collector
    - controller
    - auditorium
  gather_facts: no

  post_tasks:
    - name: Remove trust of the install SSH key by the openbach user
      authorized_key: user=openbach state=absent key={{ lookup('file', '{{ ansible_ssh_private_key_file }}.pub') }}
      become: yes


- hosts: localhost
  gather_facts: no
  post_tasks:
    - name: Remove the Controllers SSH Keys from the Local Machine
      file: path=/tmp/{{ item }} state=absent
      with_items:
        - controller_key
        - openbach_install_rsa
        - openbach_install_rsa.pub
